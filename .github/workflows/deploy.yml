# Eon Deployment
#
# Deploys EON infrastructure and apps to the specified environment.
# Secrets are pulled from Key Vault (kv-infra-405) - no secrets needed in GitHub.
#
# Required GitHub Secrets:
#   AZURE_CREDENTIALS    - Azure service principal credentials (JSON)
#
# Container Apps:
#   - eon-api-{env}
#   - eon-voice-{env}
#   - eon-memory-{env}
#   - eon-voice-gemini-{env}
#   - redis-{env}
#
# Key Vault: kv-infra-405 (rg-infra)
# ACR: eonacrpa75j7hhoqfms.azurecr.io

name: Deploy to Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-eon-dev
  ACR_NAME: eonacrpa75j7hhoqfms
  LOCATION: eastus2
  ENVIRONMENT: dev

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.tags.outputs.image_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Generate image tags
        id: tags
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "image_tag=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push API image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/eon-api-${{ env.ENVIRONMENT }}:${{ steps.tags.outputs.image_tag }} -f backend/Dockerfile backend/
          docker push ${{ env.ACR_NAME }}.azurecr.io/eon-api-${{ env.ENVIRONMENT }}:${{ steps.tags.outputs.image_tag }}

      - name: Build and push Voice image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/eon-voice-${{ env.ENVIRONMENT }}:${{ steps.tags.outputs.image_tag }} -f services/eon-voice-claude/Dockerfile services/eon-voice-claude/
          docker push ${{ env.ACR_NAME }}.azurecr.io/eon-voice-${{ env.ENVIRONMENT }}:${{ steps.tags.outputs.image_tag }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        continue-on-error: true
        run: |
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infra/main.bicep \
            --parameters environment=${{ env.ENVIRONMENT }} \
            --parameters acrServer=${{ env.ACR_NAME }}.azurecr.io \
            --parameters apiImageTag="${{ needs.build.outputs.image_tag }}" \
            --parameters voiceImageTag="${{ needs.build.outputs.image_tag }}" \
            --mode Incremental

      - name: Ensure ACR registry config
        run: |
          IDENTITY_ID=$(az identity show -n id-eon-acr-${{ env.ENVIRONMENT }} -g ${{ env.RESOURCE_GROUP }} --query id -o tsv)
          
          for APP in eon-api-${{ env.ENVIRONMENT }} eon-voice-${{ env.ENVIRONMENT }}; do
            echo "Setting registry for $APP..."
            az containerapp registry set -n $APP -g ${{ env.RESOURCE_GROUP }} \
              --server ${{ env.ACR_NAME }}.azurecr.io \
              --identity "$IDENTITY_ID" || true
          done

      - name: Update API Container App
        run: |
          az containerapp update \
            -n eon-api-${{ env.ENVIRONMENT }} \
            -g ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/eon-api-${{ env.ENVIRONMENT }}:${{ needs.build.outputs.image_tag }}

      - name: Update Voice Container App
        run: |
          az containerapp update \
            -n eon-voice-${{ env.ENVIRONMENT }} \
            -g ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/eon-voice-${{ env.ENVIRONMENT }}:${{ needs.build.outputs.image_tag }}

      - name: Verify deployment
        run: |
          echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          API_URL=$(az containerapp show -n eon-api-${{ env.ENVIRONMENT }} -g ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "**API URL:** https://$API_URL" >> $GITHUB_STEP_SUMMARY
