# Eon Dev Deployment
#
# Deploys to rg-eon-dev (the cloned dev environment)
#
# Required GitHub Secrets:
#   AZURE_CREDENTIALS    - Azure service principal credentials (JSON)
#   VOICE_API_KEY        - Azure OpenAI API key for voice (realtime)
#   VOICE_ENDPOINT       - Azure OpenAI endpoint (https://eastus2.api.cognitive.microsoft.com)
#
# Container Apps in rg-eon-dev:
#   - eon-api-dev
#   - eon-voice-dev
#   - eon-memory-dev
#   - eon-voice-gemini-dev
#   - redis-dev
#
# ACR: eonacrpa75j7hhoqfms.azurecr.io

name: Deploy to Dev

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  RESOURCE_GROUP: rg-eon-dev
  ACR_NAME: eonacrpa75j7hhoqfms
  LOCATION: eastus2

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      api_tag: ${{ steps.tags.outputs.api_tag }}
      voice_tag: ${{ steps.tags.outputs.voice_tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: Generate image tags
        id: tags
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "api_tag=eon-api-dev:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "voice_tag=eon-voice-dev:${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push API image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ steps.tags.outputs.api_tag }} -f backend/Dockerfile backend/
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ steps.tags.outputs.api_tag }}

      - name: Build and push Voice image
        run: |
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ steps.tags.outputs.voice_tag }} -f services/eon-voice-claude/Dockerfile services/eon-voice-claude/
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ steps.tags.outputs.voice_tag }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep
        continue-on-error: true
        run: |
          az deployment group create \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --template-file infra/claude.bicep \
            --parameters environment=dev \
            --parameters location=${{ env.LOCATION }} \
            --parameters voiceApiKey="${{ secrets.VOICE_API_KEY }}" \
            --parameters apiImageTag="${{ needs.build.outputs.api_tag }}" \
            --parameters voiceImageTag="${{ needs.build.outputs.voice_tag }}" \
            --mode Incremental

      - name: Ensure ACR registry config
        run: |
          # Get managed identity ID
          IDENTITY_ID=$(az identity show -n id-eon-acr-dev -g ${{ env.RESOURCE_GROUP }} --query id -o tsv)
          
          # Add registry config to container apps (idempotent)
          for APP in eon-api-dev eon-voice-dev; do
            echo "Setting registry for $APP..."
            az containerapp registry set -n $APP -g ${{ env.RESOURCE_GROUP }} \
              --server ${{ env.ACR_NAME }}.azurecr.io \
              --identity "$IDENTITY_ID" || true
          done

      - name: Update API Container App
        run: |
          az containerapp update \
            -n eon-api-dev \
            -g ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.api_tag }}

      - name: Update Voice Container App
        run: |
          az containerapp update \
            -n eon-voice-dev \
            -g ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.ACR_NAME }}.azurecr.io/${{ needs.build.outputs.voice_tag }}

      - name: Verify deployment
        run: |
          echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          API_URL=$(az containerapp show -n eon-api-dev -g ${{ env.RESOURCE_GROUP }} --query "properties.configuration.ingress.fqdn" -o tsv)
          echo "**API URL:** https://$API_URL" >> $GITHUB_STEP_SUMMARY
          SWA_URL=$(az staticwebapp list -g ${{ env.RESOURCE_GROUP }} --query "[0].defaultHostname" -o tsv 2>/dev/null || echo "N/A")
          echo "**Frontend URL:** https://$SWA_URL" >> $GITHUB_STEP_SUMMARY
